{% extends "default.html" %}
{% load static %}
{% block extrastyle %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.0/vis.min.css" type="text/css"/>
{% endblock %}
{% block og-url %}"https://www.physanthphylogeny.org/detail/{{ thePhD.URL_for_detail }}"{% endblock %}
{% block og-title %}"{{ thePhD }}, PhD"{% endblock %}
{% block content %}
    {%  if user_profile.user == request.user %}
        {% include "ownership-strip.html" %}
    {% endif %}

    <div class="container">

        {% if thePhD %}
            <div class="row section" style="margin-bottom:0px">
                <div class="col s12">
                    <div class="card amber lighten-5">
                        <div class="card-content">
                            <span class="card-title black-text">{{ thePhD }}{% if thePhD.year %} ({{ thePhD.year }}){% endif %}
                                {%  if not user_profile.user == request.user %}
                                    <a class="tooltipped" data-position="right" data-tooltip="Suggest a correction" href="/suggest_change/{{ thePhD.id }}">
                                        <i class="material-icons">mode_edit</i>
                                    </a>
                                {% endif %}
                            </span>
                            <div class="row">
                                <div class="col s12">
                                    <div class='chip blue darken-1 white-text'>{{ thePhD.school }}</div>
                                    {% for special in thePhD.specialization.all %}<div class="chip">{{ special }}</div>{% endfor %}

                                </div>
                            </div>
                            {% if user_profile %}
                                    {% if user_profile.current_position %}
                                        <div class="row">
                                            <div class="col s12 ">
                                             <b>Current position: </b>{{ user_profile.current_position }}
                                            </div>
                                        </div>

                                    {% endif %}
                                    {% if user_profile.current_affiliation %}
                                        <div class="row">
                                            <div class="col s12 ">
                                            <b>Current affiliation: </b>{{ user_profile.current_affiliation }}
                                            </div>
                                        </div>

                                    {% endif %}
                                    {% if user_profile.research_website %}
                                        <div class="row">
                                            <div class="col s12 ">
                                                <b>Research website:</b> <a target="_blank" href="{{ user_profile.research_website }}">Link</a>
                                            </div>
                                        </div>

                                    {% endif %}
                                    {% if user_profile.research_blurb %}
                                    <div class="row">
                                        <div class="col s12 ">
                                         <b>Research description:</b> {{ user_profile.research_blurb }}
                                        </div>
                                    </div>
                                    {% endif %}

                                </div>

                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
    </div>

    <div class="container">
        {% include "call2action.html" %}
    </div>


<div class="container">
            {% comment %}
            Network
            {% endcomment %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.0/vis.min.js"></script>

        <div class="row section">
            <div class="col s12 ">
                <h5>Network
                    <a href="#network-hints" id="network-hints-icon-link">
                        <i class="material-icons" style="font-size:18px;">help_outline</i>
                    </a>
                </h5>
                <div id="PhDnetwork"></div>
            </div>
        </div>
        <div id="network-hints" class="modal">
            <div class="modal-content">
                <h4>Network hints</h4>
                <p>Click on a node to fully expand it. Individuals who have advised PhDs are shown in a darker shade of yellow.</p>
                <p>Drag nodes to move the layout.</p>
                <p>Use the navigation buttons to zoom the network or to make the full network fit the window.</p>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
            </div>
        </div>
    {% comment %}
    PhD Advisor section
    {% endcomment %}
            <div class="row ">
                {% if thePhD.advisor.all %}<div class="col s12"><h5>Advisor{% if thePhD.advisor.all|length > 1 %}s{% endif %}</h5></div>{% endif %}
                {% for each in thePhD.advisor.all %}
                    <div class="col s12 ">
                            <div class="card amber lighten-5 hoverable">
                            <div class="card-content">
                                <div class="row">
                                    <div class="col s12">
                                        <span class="card-title black-text">
                                            <a href="/detail/{{ each.URL_for_detail }}">{{ each }}</a>
                                            {% if each.year %} ({{ each.year }}){% endif %}
                                            <a class="tooltipped" data-position="right" data-tooltip="Suggest a correction" href="/suggest_change/{{ each.id }}"><i class="material-icons">mode_edit</i></a>
                                        </span>
                                        <div class='chip blue darken-1 white-text'>{{ each.school }}</div>
                                        {% for special in each.specialization.all %}<div class="chip">{{ special }}</div>{% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                {% endfor %}
            </div>
            {% comment %}
            PhD student section
            {% endcomment %}
            <div class="row ">
            {% if students%}<div class="col s12"><h5>PhD Students</h5></div>{% endif %}
            {% for student in students %}
                <div class="col s12">
                        <div class="card amber lighten-5 hoverable">
                            <div class="card-content">
                                <div class="row">
                                    <div class="col s12">
                                        <span class="card-title black-text">
                                            <a href="/detail/{{ student.URL_for_detail }}">{{ student }}</a>
                                                {% if student.year %} ({{ student.year }}){% endif %}
                                            <a class="tooltipped" data-position="right" data-tooltip="Suggest a correction" href="/suggest_change/{{ student.id }}">
                                                <i class="material-icons">mode_edit</i>
                                            </a>
                                        </span>
                                        <div class='chip blue darken-1 white-text'>{{ student.school }}</div>
                                        {% for special in student.specialization.all %}<div class="chip">{{ special }}</div>{% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            {% endfor %}
            </div>
</div>
    {% else %}
        <div class="card red accent-2">
            <div class="card-content">
                <span class="card-title">There's nobody here!</span>
                Try <a class="white-text" href="/people/">searching</a> for someone
            </div>
        </div>
    {% endif %}

    </div>
{% endblock %}


{% block javascript_doc_ready %}
    <script type="text/javascript">
    $(".modal").modal();

    // create a network
    var container = document.getElementById('PhDnetwork');
    var nodes = new vis.DataSet({{ nodes|safe }})
    var edges = new vis.DataSet({{ edges|safe }})
    // provide the data in the vis format
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
        layout:{
        },
        nodes : {
            shape: 'ellipse',
            size: 10
        },
        interaction: {
          navigationButtons: true,
          keyboard: false,
          zoomView: false,
          dragView: false
        }
    };

    // initialize your network!
    var network = new vis.Network(container, data, options);
    network.on("click", function( params ) {
        {% if request.user.username != "wabarr"  %}
        ga('send', {
			hitType: 'event',
			eventCategory: 'network-click',
			eventAction: 'expand-node',
			eventLabel: params.nodes
		});
        {% endif %}
        $.getJSON("/get_network_JSON/" + params.nodes + "/", function( data ){
                nodesObj=JSON.parse(data.nodes);
                edgesObj=JSON.parse(data.edges);
                nodesAdded = false;
                $.each(nodesObj, function(n){
                    if(nodes.get(nodesObj[n].id)){} else {
                        nodes.add(nodesObj[n]);
                        nodesAdded = true;
                    }
                });

                $.each(edgesObj, function(e) {
                    var edgeExists = edges.get({
                        filter: function (item) {
                            return item.from == edgesObj[e].from && item.to == edgesObj[e].to;
                        }
                    });
                    if(edgeExists.length > 0){
                        //do nothing
                    }else{
                        edges.add(edgesObj[e]);
                    }
                });

            if(nodesAdded === true) {
                setTimeout(function(){
                network.fit({
                nodes: getNodeIDs(),
                animation: true
                });
            }, 1500);
            };
        });
    });
    var getNodeIDs = function(){
        var output = []
        $.each(nodes, function(n){
            output.push(n.id);
        });
    };

    {% if request.user.username != "wabarr"  %}
        $(".vis-button").click(function(){
            ga('send', {
			hitType: 'event',
			eventCategory: 'network-click',
			eventAction: 'network-navigate-button',
			eventLabel: $(this).attr("class")
		    });
        });
        $("#network-hints-icon-link").click(function(){
            ga('send', {
			hitType: 'event',
			eventCategory: 'network-hints',
			eventAction: 'network-hints-trigger-modal',
			eventLabel: 'network-hints-trigger-modal'
		    });
        });
    {% endif %}
    </script>
{% endblock %}
